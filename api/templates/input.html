{% extends "base.html" %}
{% block head %}

  <link rel=stylesheet type=text/css href="{{ url_for('static', filename='css/phame-loading.css') }}">
  <link rel=stylesheet type=text/css href="{{ url_for('static', filename='css/phame-input.css') }}">
<script>
    function outputUpdate(cutoff) {
          document.querySelector('#selected-cutoff').value = Math.round(cutoff * 100) / 100;
      }
    function showRefFileAlert() {
      alert("Please select a file from Reference Genome");
    }
    function referenceFileUpdate() {
      console.log("updated file list");
      var genome_files = document.getElementById("ref_dir");
      var ref_value = document.getElementById("reference").value;
      console.log(genome_files);
      for (i = 0; i < genome_files.files.length; i++) {
        console.log(genome_files.files[i]);
        reference_file.options.add(new Option(genome_files.files[i].name, genome_files.files[i].name));
      }
      if (ref_value === '1') {
        {#showRefFileAlert();#}
      }
    }

    function showBootstrap() {
        var tree_value = document.getElementById("tree").value;
        console.log(tree_value);
        var bootstrap = document.getElementById("bootstrapshow");
        if (tree_value === '2' || tree_value === '3'|| tree_value === '4') {
            bootstrap.style.display = "block";
        } else {
            bootstrap.style.display = "none";
        }
    }

    function showBootstrapN() {
        var bootstrap_value = document.getElementById("bootstrap").value;
        console.log(bootstrap_value);
        var bootstrapN = document.getElementById("bootstrapN");
        if (bootstrapN.style.display === "none" && bootstrap_value === '1') {
            bootstrapN.style.display = "block";
        } else {
            bootstrapN.style.display = "none";
        }
    }

    function showReadfileInput() {
        var data_type_value = document.getElementById("data_type-2").checked;
        console.log(data_type_value);
        var reads_file = document.getElementById("reads_file");
        var aligner_div = document.getElementById("aligner_div");
        var reads_combo_div = document.getElementById("reads_combo_div");
        if (reads_file.style.display === "none" && data_type_value) {
            reads_file.style.display = "block";
            aligner_div.style.display = "block";
            reads_combo_div.style.display = "block";
        } else if (reads_file.style.display === "block" && !data_type_value) {
            reads_file.style.display = "none";
            aligner_div.style.display = "none";
            reads_combo_div.style.display = "none";
        }

        var data_type_value1 = document.getElementById("data_type-1").checked;
        console.log(data_type_value1);
        var contigs_file = document.getElementById("contigs_file");
        if (contigs_file.style.display === "none" && data_type_value1) {
            contigs_file.style.display = "block";
        } else if (contigs_file.style.display === "block" && !data_type_value1) {
            contigs_file.style.display = "none";
        }
    }

    function showPOS() {
        var do_select_value = document.getElementById("do_select").value;
        console.log(do_select_value);
        var show_pos = document.getElementById("pos");
        if (show_pos.style.display === "none" && do_select_value === '1') {
            show_pos.style.display = "block";
        } else {
            show_pos.style.display = "none";
        }

    }

    function showReferenceFile() {
        var ref_value = document.getElementById("reference").value;
        console.log(ref_value);
        var ref_file = document.getElementById("ref_file_div");
        if (ref_file.style.display === "none" && ref_value === '1') {
            ref_file.style.display = "block";
        } else {
            ref_file.style.display = "none";
        }
    }

    function showAlert() {
      alert("Project submitted. Your results will be displayed momentarily")
    }

    function showLoading() {
        var loading_div = document.getElementById("loading");
        var content_div = document.getElementById("content");
        var project_name = document.getElementById("project").value;
        loading_div.style.display = 'block';
        content_div.style.display = 'none';
        document.getElementById("project-name").innerHTML = 'running ' + project_name + '...';
    }
    </script>

{% endblock %}

{% block content %}
<div id="loading">
  <div id="project-name"></div>
  <div id="show-img"></div>
</div>

<div id="content">
    <h1>PhaME</h1>

    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <ul class=flashes>
        {% for message in messages %}
          <li>{{ message }}</li>
        {% endfor %}
        </ul>
      {% endif %}
    {% endwith %}
    <form action="" method="post" enctype="multipart/form-data" novalidate>
    {% if error %}
    <p class=error><strong>Error:</strong> {{ error }}
  {% endif %}


        {{ form.hidden_tag() }}
        <div class="flex-container-col">
          <div class="flex-container-row">
            <div class="flex-label">{{ form.project.label }}</div>
            <div class="flex-field">{{ form.project(title='Project name must be unique', data_toggle="tooltip") }}</div>
              {% for error in form.project.errors %}
                <span style="color: red;">[{{ error }}]</span>
              {% endfor %}

          </div>
          <div class="flex-container-row">
              <div class="flex-label">{{ form.data_type.label }}</div>
              <div class="flex-field">{{ form.data_type(title='Choose from complete(F), only Contig (C) or only Reads (R)', data_toggle="tooltip", onchange="showReadfileInput(event)") }}</div>
              {% for error in form.data.errors %}
                <span style="color: red;">[{{ error }}]</span>
              {% endfor %}
          </div>
          <div class="flex-container-row">
              <div class="flex-label">{{ form.ref_dir.label }}</div>
              <div class="flex-field">{{ form.ref_dir(title='Reference genome files (.fasta/.fna/.gff)', data_toggle="tooltip", onchange="referenceFileUpdate()") }}</div>
              {% for error in form.ref_dir.errors %}
                <span style="color: red;">[{{ error }}]</span>
              {% endfor %}
          </div>
          <div id="contigs_file" style="display: none;">
              <div class="flex-container-row">
                  <div class="flex-label">{{ form.work_dir.label }}</div>
                  <div class="flex-field">{{ form.work_dir(title='Contigs files (.fasta/.fna/.gff)', data_toggle="tooltip") }}</div>
                  {% for error in form.work_dir.errors %}
                    <span style="color: red;">[{{ error }}]</span>
                  {% endfor %}
              </div>
          </div>
          <div id="reads_combo_div" style="display: none;">
              <div class="flex-container-row">
                  <div class="flex-label">{{ form.reads.label }}</div>
                  <div class="flex-field">{{ form.reads(title='Select Single-ended, paired-ended or both', data_toggle="tooltip") }}</div>
                  {% for error in form.reads.errors %}
                    <span style="color: red;">[{{ error }}]</span>
                  {% endfor %}
              </div>
          </div>
          <div id="reads_file" style="display: none;">
            <div class="flex-container-row">
                <div class="flex-label">{{ form.reads_file.label }}</div>
                <div class="flex-field">{{ form.reads_file(title='Upload Reads file', data_toggle="tooltip") }}</div>
                {% for error in form.reads_file.errors %}
                  <span style="color: red;">[{{ error }}]</span>
                {% endfor %}
            </div>
          </div>
          <div class="flex-container-row">
              <div class="flex-label">{{ form.reference.label }}</div>
              <div class="flex-field">{{ form.reference(title='Choose whether to use a random reference file, reference calculated from ANI or use a file of your choosing', data_toggle="tooltip", onchange="showReferenceFile()") }}</div>
              {% for error in form.reference.errors %}
                <span style="color: red;">[{{ error }}]</span>
              {% endfor %}
          </div>
          <div id="ref_file_div" style="display: block">
              <div class="flex-container-row">
                  <div class="flex-label">{{ form.reference_file.label }}</div>
                  <div class="flex-field">{{ form.reference_file(title='Select a reference file', data_toggle="tooltip") }}</div>
                  {% for error in form.reference_file.errors %}
                    <span style="color: red;">[{{ error }}]</span>
                  {% endfor %}
              </div>
          </div>
          <div id="aligner_div" style="display: none;">
              <div class="flex-container-row">
                  <div class="flex-label">{{ form.aligner.label }}</div>
                  <div class="flex-field">{{ form.aligner(title='Choose an aligner', data_toggle="tooltip") }}</div>
                  {% for error in form.aligner.errors %}
                    <span style="color: red;">[{{ error }}]</span>
                  {% endfor %}
              </div>
          </div>
          <div class="flex-container-row">
              <div class="flex-label">{{ form.cutoff.label }}</div>
              <div class="flex-field">{{ form.cutoff(min=0, max=1, oninput="outputUpdate(value)",
                title='Linear alignment (LA) coverage against reference - ignores SNPs from organism that have lower cutoff.', data_toggle="tooltip") }}
              <output for="cutoff" id="selected-cutoff">{{ form.cutoff.data }}</output></div>

              {% for error in form.cutoff.errors %}
                <span style="color: red;">[{{ error }}]</span>
              {% endfor %}
          </div>

          <div class="flex-container-row">
              <div class="flex-label">{{ form.cds_snps.label }}</div>
              <div class="flex-field">{{ form.cds_snps(title='divides SNPs into coding and non-coding sequences, gff file is required', data_toggle="tooltip") }}</div>
              {% for error in form.cds_snps.errors %}
                <span style="color: red;">[{{ error }}]</span>
              {% endfor %}
          </div>
          <div class="flex-container-row">
              <div class="flex-label">{{ form.buildSNPdb.label }}</div>
              <div class="flex-field">{{ form.buildSNPdb(title='Build SNP database', data_toggle="tooltip") }}</div>
              {% for error in form.buildSNPdb.errors %}
                <span style="color: red;">[{{ error }}]</span>
              {% endfor %}
          </div>
          <div class="flex-container-row">
              <div class="flex-label">{{ form.tree.label }}</div>
              <div class="flex-field">{{ form.tree(title='Choose an aligner', data_toggle="tooltip", onchange="showBootstrap()") }}</div>
              {% for error in form.tree.errors %}
                <span style="color: red;">[{{ error }}]</span>
              {% endfor %}
          </div>
        <div id="bootstrapshow" style="display:none;">
          <div class="flex-container-row">
              <div class="flex-label">{{ form.bootstrap.label }}</div>
              <div class="flex-field">{{ form.bootstrap(title='Do you want to create bootstrap trees?', data_toggle="tooltip", onchange="showBootstrapN()") }}</div>
              {% for error in form.bootstrap.errors %}
                <span style="color: red;">[{{ error }}]</span>
              {% endfor %}
          </div>
        </div>
      <div id="bootstrapN" style="display:none;">
          <div class="flex-container-row">
              <div class="flex-label">{{ form.N.label }}</div>
              <div class="flex-field">{{ form.N(title='Specify the number of bootstrap trees to generate', data_toggle="tooltip") }}</div>
              {% for error in form.N.errors %}
                <span style="color: red;">[{{ error }}]</span>
              {% endfor %}
          </div>
      </div>
          <div class="flex-container-row">
              <div class="flex-label">{{ form.do_select.label }}</div>
              <div class="flex-field">{{ form.do_select(title='Do you want to do molecular evolution analysis?'
                'Turning this option ON will significantly slow the runtime. If this option is turned ON, you must '
                'provide the gff file for the corresponding reference genome.', data_toggle="tooltip", onchange="showPOS()") }}</div>
              {% for error in form.do_select.errors %}
                <span style="color: red;">[{{ error }}]</span>
              {% endfor %}
          </div>
          <div id="pos" style="display:none;">
            <div class="flex-container-row">
                <div class="flex-label">{{ form.pos_select.label }}</div>
                <div class="flex-field">{{ form.pos_select(title='Select Molecular Evolution analysis algorithm to use', data_toggle="tooltip") }}</div>
                {% for error in form.pos_select.errors %}
                  <span style="color: red;">[{{ error }}]</span>
                {% endfor %}
            </div>
          </div>
          <div class="flex-container-row">
              <div class="flex-label">{{ form.clean.label }}</div>
              <div class="flex-field">{{ form.clean(title='Turning this option ON will remove intermediate files', data_toggle="tooltip") }}</div>
              {% for error in form.clean.errors %}
                <span style="color: red;">[{{ error }}]</span>
              {% endfor %}
          </div>
          <div class="flex-container-row">
              <div class="flex-label">{{ form.threads.label }}</div>
              <div class="flex-field">{{ form.threads(title='Specify the number of threads to run analysis ON (between 1 and 16)', data_toggle="tooltip") }}</div>
              {% for error in form.threads.errors %}
                <span style="color: red;">[{{ error }}]</span>
              {% endfor %}
          </div>
      </div>
        <p>{{ form.submit(onclick="showLoading()") }}</p>
    </form>
</div>
{% endblock %}

